<!doctype html>
<html>
<head>

<title>iReporter</title>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat:100,200,300,400" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
<link rel="stylesheet" href="css/app.css">
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLhtMsy7x0mDj8a3UWU6KmDZ7jD10-vic&libraries=places"></script>
<script src="js/app.js"></script>
</head>
<body onload="bindModel()">
    <div>
        <nav class="p-1">
            <div class="container">
                <div class="header-top black">
                    <h1 class="">iReporter</h1>
        
                    <div class="flex header-nav item-center">
                        <a class="black text-normal" href="dashboard.html">Dashboard</a>
                        <a class="black text-normal" href="profile.html">Profile</a>
                        <a id="signup" class="black text-normal border signup-button box-shadow" href="signup.html">Sign Up</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex">
            <div class="w-quarter content-wrap">
                <div class="flex flex-column content-left px-3-md pt-6 tab">
                    <span class="flex flex-wrap pt-2">
                        <a class="font-monseratt grey-light bold tablinks" href="#" ><i class="far fa-flag"></i> &nbsp; Red Flags</a>
                    </span>
                    <span class="flex flex-wrap pt-2 tablinks">
                        <a class="font-monseratt grey-light bold" href="#"><i class="fas fa-hands-helping"></i> &nbsp; Interventions</a>
                    </span>
                </div>
            </div>

            <div class="w-rem bg-grey-lighter flex flex-column">
                
                    <div class="flex-container flex-column h-full mt-4 mb-4">
                        <div class="card card-lg border-rounded-sm box-shadow-sm">
                            <form class="flex flex-column" onsubmit="event.preventDefault(); updateRecord()">
                
                                <div class="form-control form-input">
                                    <label class="font-monseratt fs-1" for="email">Title</label>
                                    <input id="title" class="font-monseratt fs-1" type="text" name="title">
                                </div>
                                <div class="form-control form-input">
                                    <label for="location" class="font-monseratt fs-1">Location</label>
                                    <input id="location" class="font-monseratt fs-1" name="location" type="text" onkeyup="locationSearch()">
                                </div>
                                <div class="form-control form-input">
                                    <label for="incident_type" class="font-monseratt">Record Type</label>
                                    <br>
                                    <select id="incident_type" class="font-monseratt fs-1" name="incident_type">
                                        <option value="red_flag">Red Flag</option>
                                        <option value="intervention">Intervention</option>
                                    </select>
                                </div>
                                <div class="form-control form-input">
                                    <label for="status" class="font-monseratt fs-1">Status</label>
                                    <br>
                                    <select id="status" onchange="updateStatus()" class="font-monseratt fs-1" name="status">
                                        <option value="draft">Draft</option>
                                        <option value="resolved">Pending</option>
                                        <option value="under_investigation">Under Investigation</option>
                                        <option value="rejected">Rejected</option>
                                        <option value="resolved">Resolved</option>
                                    </select>
                                </div>
                                <div class="form-control form-input">
                                    <label class="font-monseratt fs-1" for="description">Description</label>
                                    <br>
                                    <textarea class="font-monseratt fs-1" name="description" id="description" cols="30" rows="10" placeholder="Lorem, ipsum dolor sit amet consectetur adipisicing elit. At eligendi doloribus corporis, earum quos dolore alias laudantium hic autem. Eum saepe tenetur dolor, debitis assumenda quod incidunt libero nemo maiores!"></textarea>
                                </div>
                                <div class="form-control form-input">
                                    <label for="media" class="font-monseratt fs-1">Media</label>
                                    <input type="file" accept="image/*,video/*" name="media">
                                </div>
                            
                                <div class="form-control"> 
                                    <button class="white w-full bg-black white tm border btn fs-1 font-monseratt">Update</button>
                                </div>
                            </form>
                        </div>
                    </div>
                
            </div>
        </div>
    </div>
<script>

    if (localStorage.getItem('auth_token')) {
        document.getElementById('signup').style = 'display: none;'
    }

   function bindModel() {
        incidentModel = JSON.parse(localStorage.getItem('current_incident'))
        console.log(incidentModel)
        
        columns = ['title', 'location', 'status', 'incident_type', 'description']

        columns.map(function(column){
            document.getElementById(column).value = incidentModel[column]
            console.log(column)

            if (column == 'location') {
                document.getElementById(column).value = incidentModel[column]['city']
            }

            if (column == 'incident_type' || column == 'status') {
                document.querySelector(`#${column} [value="` + incidentModel[column] + `"]`).selected = true;
            }
        })
    }

    function updateRecord() {
        url = baseUrl + `incidents/${JSON.parse(localStorage.getItem('current_incident')).id}`
        
        incident_dropdown = document.getElementById('incident_type') 
        choice = incident_dropdown.options[incident_dropdown.selectedIndex].value

        formData = {
            incident_type: choice,
            description: document.getElementsByName('description')[0].value,
            title: document.getElementsByName('title')[0].value,
            location: locationObject
        }

        patch(url, formData)
        .then(response => response.json())
        .then(data => {
            console.log(data)
            window.location = 'dashboard.html'
        })
        .catch(errors => {
            console.log(errors)
        })

        bindModel()
    }

    function updateStatus() {
        url = baseUrl + `admin/incidents/${JSON.parse(localStorage.getItem('current_incident')).id}`

        incident_dropdown = document.getElementById('status') 
        choice = incident_dropdown.options[incident_dropdown.selectedIndex].value

        patch(url, {status: choice})
        .then(response => response.json())
        .then(data => {
            console.log(data)
        }).catch(errors => {
            console.log(errors)
        })
    }
</script>
</body>
</html>